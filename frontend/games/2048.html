<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>2048</title>
  <style>
    body { background:#1e1e2f; display:flex; justify-content:center; align-items:center; height:100vh; color:#fff; font-family:Arial,sans-serif; }
    #board { display:grid; grid-template-columns:repeat(4,100px); grid-gap:5px; background:#3b3b5a; padding:5px; border-radius:8px; }
    .tile { width:100px; height:100px; display:flex; align-items:center; justify-content:center; font-size:24px; font-weight:bold; border-radius:8px; }
    #score { position:absolute; top:20px; left:20px; font-size:20px; }
  </style>
</head>
<body>
  <div id="score">Score: 0</div>
  <div id="board"></div>
  <script>
    const board = document.getElementById("board");
    let grid = Array(4).fill().map(()=>Array(4).fill(0));
    let score = 0;

    function updateBoard() {
      board.innerHTML = "";
      grid.forEach(row => {
        row.forEach(val => {
          const div = document.createElement("div");
          div.className = "tile";
          div.textContent = val > 0 ? val : "";
          div.style.background = val ? "#3b82f6" : "#2f2f44";
          board.appendChild(div);
        });
      });
      document.getElementById("score").innerText = "Score: " + score;
    }

    function addRandomTile() {
      let empty = [];
      grid.forEach((row,y)=>row.forEach((v,x)=>{ if(!v) empty.push({x,y}); }));
      if (empty.length) {
        let {x,y} = empty[Math.floor(Math.random()*empty.length)];
        grid[y][x] = Math.random()<0.9 ? 2 : 4;
      }
    }

    function slide(row) {
      row = row.filter(v=>v);
      for (let i=0;i<row.length-1;i++) {
        if (row[i]===row[i+1]) {
          row[i]*=2;
          score+=row[i];
          row[i+1]=0;
        }
      }
      row=row.filter(v=>v);
      while(row.length<4) row.push(0);
      return row;
    }

    function rotateGrid(times=1) {
      for(let t=0;t<times;t++) {
        grid = grid[0].map((_,i)=>grid.map(row=>row[i]).reverse());
      }
    }

    function move(dir) {
      let moved=false;
      if (dir==="left") {
        for(let i=0;i<4;i++){ let newRow=slide(grid[i]); if(newRow.toString()!==grid[i].toString()){moved=true;} grid[i]=newRow; }
      } else if (dir==="right") {
        for(let i=0;i<4;i++){ grid[i].reverse(); let newRow=slide(grid[i]); newRow.reverse(); if(newRow.toString()!==grid[i].toString()){moved=true;} grid[i]=newRow; }
      } else if (dir==="up") {
        rotateGrid(); move("left"); rotateGrid(3); return;
      } else if (dir==="down") {
        rotateGrid(); move("right"); rotateGrid(3); return;
      }
      if(moved) addRandomTile();
      updateBoard();
      if (isGameOver()) {
        sendScore(score, 2); // Game ID = 2 for 2048
        alert("Game Over! Score: " + score);
      }
    }

    function isGameOver() {
      for(let y=0;y<4;y++){ for(let x=0;x<4;x++){ if(grid[y][x]===0) return false;
        if(x<3 && grid[y][x]===grid[y][x+1]) return false;
        if(y<3 && grid[y][x]===grid[y+1][x]) return false; } }
      return true;
    }

    document.addEventListener("keydown", e=>{
      if(e.key==="ArrowLeft") move("left");
      if(e.key==="ArrowRight") move("right");
      if(e.key==="ArrowUp") move("up");
      if(e.key==="ArrowDown") move("down");
    });

    function sendScore(score, gameId) {
      fetch("../save_score.php", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({score: score, game_id: gameId})
      });
    }

    addRandomTile();
    addRandomTile();
    updateBoard();
  </script>
</body>
</html>
